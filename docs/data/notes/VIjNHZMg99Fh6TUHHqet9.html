<h1 id="alter"><a aria-hidden="true" class="anchor-heading" href="#alter"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Alter</h1>
<h3 id="alter-column-to-have-unique-constraint"><a aria-hidden="true" class="anchor-heading" href="#alter-column-to-have-unique-constraint"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Alter column to have unique constraint</h3>
<p><code>ALTER TABLE foo ADD UNIQUE (column_name);</code></p>
<h3 id="adddrop-column-constraint"><a aria-hidden="true" class="anchor-heading" href="#adddrop-column-constraint"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>add/drop column constraint</h3>
<pre class="language-sql"><code class="language-sql"><span class="token keyword">alter</span> <span class="token keyword">table</span> invoice_items <span class="token keyword">alter</span> <span class="token keyword">column</span> invoice_id <span class="token keyword">set</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">;</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> invoice_items <span class="token keyword">alter</span> <span class="token keyword">column</span> invoice_id <span class="token keyword">drop</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="add-non-nullable-column-to-a-table"><a aria-hidden="true" class="anchor-heading" href="#add-non-nullable-column-to-a-table"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Add non-nullable column to a table</h3>
<p>This can be tricky, since running</p>
<pre class="language-sql"><code class="language-sql"><span class="token keyword">alter</span> <span class="token keyword">table</span> invoice_items <span class="token keyword">add</span> <span class="token keyword">column</span> payment_id uuid <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre>
<p>will result in an error, since we are trying to modify existing rows in a table to have a <code>null</code> value for the new column</p>
<p>Instead, we have a bit of a workaround, setting some junk default value to get around the constraint.</p>
<pre class="language-sql"><code class="language-sql"><span class="token keyword">alter</span> <span class="token keyword">table</span> mytable <span class="token keyword">add</span> <span class="token keyword">column</span> mycolumn <span class="token keyword">character</span> <span class="token keyword">varying</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">default</span> <span class="token string">'foo'</span><span class="token punctuation">;</span>
<span class="token comment">-- ... some work (set real values as you want)...</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> mytable <span class="token keyword">alter</span> <span class="token keyword">column</span> mycolumn <span class="token keyword">drop</span> <span class="token keyword">default</span><span class="token punctuation">;</span>
</code></pre>
<p>In the case where we are adding a non-nullable FK, we can take a bit of a different approach:</p>
<pre class="language-sql"><code class="language-sql"><span class="token keyword">alter</span> <span class="token keyword">table</span> invoice_items <span class="token keyword">add</span> <span class="token keyword">column</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> payment_id uuid <span class="token keyword">references</span> payments<span class="token punctuation">;</span>
<span class="token comment">-- ... some work (set real values as you want)...</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> invoice_items <span class="token keyword">alter</span> <span class="token keyword">column</span> payment_id <span class="token keyword">set</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">;</span>
</code></pre>
<h4 id="alternative-approach-check-constraint"><a aria-hidden="true" class="anchor-heading" href="#alternative-approach-check-constraint"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Alternative approach: check constraint</h4>
<p><a href="/Digital-Garden/notes/qUAQVamU4gH2VbSZS7tlk#differences-between-a-column-not-null-constraint-and-a-check-constraint-not-null">Differences between a column NOT NULL constraint and a CHECK CONSTRAINT not null</a></p>
<p>The trick here is that you can issue a <code>NOT VALID</code> option when adding a check constraint. This will tell PostgreSQL that you are aware that the constraint may not be valid on existing data and that it does not have to check it. Subsequent inserts or updates, however, will be enforced.</p>
<pre class="language-sql"><code class="language-sql"><span class="token keyword">alter</span> <span class="token keyword">table</span> invoice_items <span class="token keyword">add</span> <span class="token keyword">constraint</span> payment_id_not_null <span class="token keyword">check</span> <span class="token punctuation">(</span>payment_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">)</span> <span class="token operator">not</span> valid<span class="token punctuation">;</span>
</code></pre>
<p>After you have done your operations, then we can <code>validate</code> the sql:</p>
<pre class="language-sql"><code class="language-sql"><span class="token keyword">alter</span> <span class="token keyword">table</span> invoice_items validate <span class="token keyword">constraint</span> payment_id_not_null<span class="token punctuation">;</span>
</code></pre>
<p>This will scan the table and ensure that the constraints are all passing</p>