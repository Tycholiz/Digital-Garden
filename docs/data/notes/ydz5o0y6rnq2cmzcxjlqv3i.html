<h1 id="api">API<a aria-hidden="true" class="anchor-heading icon-link" href="#api"></a></h1>
<h3 id="jestfn"><code>jest.fn()</code><a aria-hidden="true" class="anchor-heading icon-link" href="#jestfn"></a></h3>
<p>Allows us to mock a function</p>
<p>Used when we want to mock a function, and don't really care about its original implementation (often just mocking the return value)</p>
<ul>
<li>returns a <code>spy</code> (which remembers each call that was made on it)</li>
<li>creates a stub</li>
<li>useful in removing dependencies to some backend (eg. server, API)</li>
</ul>
<p>If we pass an argument, then it means we are passing a mock implementation:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> queryMock <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token function">queryMock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// Promise { pending }</span>
</code></pre>
<h3 id="jestspyonobject-methodname"><code>jest.spyOn(object, methodName)</code><a aria-hidden="true" class="anchor-heading icon-link" href="#jestspyonobject-methodname"></a></h3>
<p>Creates a mock function like <code>jest.fn</code>, but also tracks calls to the method, allowing us to spy on them</p>
<ul>
<li>this allows to ensure that the functions are called as expected (e.g. with correct arguments)</li>
</ul>
<p>spies still call the original code, they arenâ€™t complete mocks. They are called spies because they "spy" on the implementation code.</p>
<pre class="language-ts"><code class="language-ts">jest<span class="token punctuation">.</span><span class="token method function property-access">spyOn</span><span class="token punctuation">(</span><span class="token maybe-class-name">AutomationsDataSource</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">,</span> <span class="token string">'deleteAutomation'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">mockResolvedValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>Or, we can add conditional logic:</p>
<pre class="language-ts"><code class="language-ts">jest<span class="token punctuation">.</span><span class="token method function property-access">spyOn</span><span class="token punctuation">(</span><span class="token maybe-class-name">AutomationsDataSource</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">,</span> <span class="token string">'getAutomation'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">mockImplementation</span><span class="token punctuation">(</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> automation<span class="token operator">:</span> <span class="token maybe-class-name">Automation</span>
  <span class="token keyword control-flow">switch</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> a1<span class="token punctuation">.</span><span class="token property-access">id</span><span class="token operator">:</span>
      automation <span class="token operator">=</span> a1
      <span class="token keyword control-flow">break</span>
    <span class="token keyword">case</span> a2<span class="token punctuation">.</span><span class="token property-access">id</span><span class="token operator">:</span>
      automation <span class="token operator">=</span> a2
      <span class="token keyword control-flow">break</span>
    <span class="token keyword module">default</span><span class="token operator">:</span>
      automation <span class="token operator">=</span> <span class="token keyword nil">undefined</span>
  <span class="token punctuation">}</span>
  <span class="token keyword control-flow">return</span> <span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span>automation<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p>We can also mock as many methods as we want:</p>
<pre class="language-ts"><code class="language-ts">jest<span class="token punctuation">.</span><span class="token method function property-access">spyOn</span><span class="token punctuation">(</span><span class="token maybe-class-name">AutomationsDataSource</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">,</span> <span class="token string">'getAutomation'</span><span class="token punctuation">,</span> <span class="token string">'deleteAutomation'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">mockImplementation</span><span class="token punctuation">(</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
<span class="token comment">// ...</span>
</code></pre>
<h3 id="jestmock"><code>jest.mock()</code><a aria-hidden="true" class="anchor-heading icon-link" href="#jestmock"></a></h3>
<p><code>jest.mock</code> allows us to mock an entire module</p>
<p>If we call <code>jest.mock</code> with only 1 arg,</p>
<ul>
<li>the module we pass will be replaced simply with <code>jest.fn</code></li>
</ul>
<p>If we call <code>jest.mock</code> with 2 args,</p>
<ul>
<li>the module we pass will be replaced with the return value of the function provided (arg2).
<ul>
<li>in other words, if there is 2 args, <code>jest.mock</code> says "replace all occurrences of arg1 with arg2"</li>
</ul>
</li>
</ul>
<p>This code tells jest, "any time <code>calculateAge</code> is called, stick in 42 as its return value"</p>
<ul>
<li>we say "any time you import <code>calculateAge</code> into some other module, replace its value with <code>jest.fn(() => 42)</code></li>
</ul>
<pre class="language-js"><code class="language-js">jest<span class="token punctuation">.</span><span class="token method function property-access">mock</span><span class="token punctuation">(</span><span class="token string">'../calculateAge'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> jest<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// This runs the function specified as second argument to `jest.mock`.</span>
<span class="token keyword">const</span> calculateAge <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../calculateAge'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">calculateAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Will return '42';</span>
</code></pre>
<h4 id="example">Example<a aria-hidden="true" class="anchor-heading icon-link" href="#example"></a></h4>
<pre class="language-ts"><code class="language-ts">jest<span class="token punctuation">.</span><span class="token method function property-access">mock</span><span class="token punctuation">(</span><span class="token string">'../components/box.jsx'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token string">'Box'</span><span class="token punctuation">)</span>
</code></pre>
<ul>
<li>this is saying "for the component we are testing, take all instances of the <code>Box</code> component and replace them with the text <code>Box</code>"</li>
<li>what's happening underlying is that since components are just functions, we are saying "replace our component function with the function <code>() => 'Box'</code>"</li>
<li>we do this when we don't really care about all the props that come with box, but are just interested in the structure. <code>&#x3C;Box /></code> doesn't really matter, since that isn't what we are testing.</li>
<li>we do this basically when our proptypes fails, because we aren't supplying data in the way proptypes would expect (ex. passing to <code>Box</code> margin as <code>25px</code> rather than the expected <code>25</code>)</li>
</ul>
<p>When we do <code>jest.mock('./my-file.js')</code>, it will turn all functions into Jest mock functions and all objects will have more properties on them like, <code>mockReturnValueOnce</code></p>
<p>spec: Mocks get hoisted, so if there is a variable you define <em>after</em> the mock, you probably won't be able to use it</p>
<pre class="language-js"><code class="language-js">jest<span class="token punctuation">.</span><span class="token method function property-access">mock</span><span class="token punctuation">(</span><span class="token string">'./isValidCoupon'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token comment">// isValidCoupon: async () => true,</span>
    <span class="token literal-property property">isValidCoupon</span><span class="token operator">:</span> jest<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">mockImplementation</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="mocking-individual-functions">Mocking individual functions<a aria-hidden="true" class="anchor-heading icon-link" href="#mocking-individual-functions"></a></h3>
<p>Imagine our implementation code file is made up of individually exported functions, and we want to mock one of them. We can use <code>jest.requireActual</code> to import the original implementation, but mock individual functions:</p>
<pre class="language-ts"><code class="language-ts">jest<span class="token punctuation">.</span><span class="token method function property-access">mock</span><span class="token punctuation">(</span><span class="token string">'./automationVersions'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> origModule <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token method function property-access">requireActual</span><span class="token punctuation">(</span><span class="token string">'./automationVersions'</span><span class="token punctuation">)</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
    <span class="token spread operator">...</span>origModule<span class="token punctuation">,</span>
    doesDraftExist<span class="token operator">:</span> jest<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p>Then, in our unit test we can mock the return value:</p>
<pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> mockedDoesDraftExist <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token method function property-access">mocked</span><span class="token punctuation">(</span>doesDraftExist<span class="token punctuation">)</span>
mockedDoesDraftExist<span class="token punctuation">.</span><span class="token method function property-access">mockReturnValue</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
</code></pre>