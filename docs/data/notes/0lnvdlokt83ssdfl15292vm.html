<h1 id="testing-in-nestjs">Testing in Nestjs<a aria-hidden="true" class="anchor-heading icon-link" href="#testing-in-nestjs"></a></h1>
<p>The <code>Test</code> class is useful for providing an application execution context that essentially mocks the full Nest runtime, but gives you hooks that make it easy to manage class instances, including mocking and overriding.</p>
<h3 id="createtestingmodule"><code>createTestingModule</code><a aria-hidden="true" class="anchor-heading icon-link" href="#createtestingmodule"></a></h3>
<p><code>Test.createTestingModule()</code> takes a module metadata object as its argument. It returns a <code>TestingModule</code> instance which in turn provides a few methods. </p>
<ul>
<li>to this method we pass an object that looks the same as when we are defining a <code>@Module</code> in a <code>.module.ts</code> file.
<ul>
<li>we are really just trying to simulate the module in a minimalist way, where we include only what is needed for the particular test file.</li>
</ul>
</li>
<li>the resulting <code>TestingModule</code> is an isolated NestJS runtime. As a result, it gets all the NestJS behaviors like dependency injection.
<ul>
<li>for unit tests, <code>compile()</code> is the most important one, which bootstraps a module with its dependencies (similar to the way an application is bootstrapped in the conventional <code>main.ts</code> file using <code>NestFactory.create()</code>), and returns a module that is ready for testing.</li>
</ul>
</li>
</ul>
<p>The resultant TestingModule is limited to what you define when using the Test class (e.g. which <code>providers</code>/<code>controllers</code> you include)</p>
<ul>
<li>ex. if you pass <code>TweetsService</code> to <code>providers</code>, then you will get access to all of the methods inside <code>TweetsService</code>.
<ul>
<li>you will want to make an instance of an injectable/controller:</li>
</ul>
<pre class="language-ts"><code class="language-ts">service <span class="token operator">=</span> module<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">get</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token maybe-class-name">TweetsService</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token maybe-class-name">TweetsService</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
</li>
</ul>
<h3 id="mocking">Mocking<a aria-hidden="true" class="anchor-heading icon-link" href="#mocking"></a></h3>
<p>Imagine we have the following TestingModule:</p>
<pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> module<span class="token operator">:</span> <span class="token maybe-class-name">TestingModule</span> <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token maybe-class-name">Test</span><span class="token punctuation">.</span><span class="token method function property-access">createTestingModule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  controllers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">UsersController</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">UsersService</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">compile</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>If <code>UsersService</code> has dependencies that need to be injected in order for it to work, we will get the <code>Nest can't resolve dependencies</code> error. If we don't care about the dependencies of the <code>UsersService</code>, we can simply mock it:</p>
<pre class="language-ts"><code class="language-ts"><span class="token keyword">let</span> controller<span class="token operator">:</span> <span class="token maybe-class-name">UsersController</span>
<span class="token keyword">const</span> mockUsersService <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> module<span class="token operator">:</span> <span class="token maybe-class-name">TestingModule</span> <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token maybe-class-name">Test</span><span class="token punctuation">.</span><span class="token method function property-access">createTestingModule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    controllers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">UsersController</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    providers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">UsersService</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">overrideProvider</span><span class="token punctuation">(</span><span class="token maybe-class-name">UsersService</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">useValue</span><span class="token punctuation">(</span>mockUsersService<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">compile</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  service <span class="token operator">=</span> module<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">get</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token maybe-class-name">TweetsService</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token maybe-class-name">TweetsService</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>