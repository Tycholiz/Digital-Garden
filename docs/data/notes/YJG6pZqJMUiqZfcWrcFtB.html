<h1 id="pipelines">Pipelines<a aria-hidden="true" class="anchor-heading icon-link" href="#pipelines"></a></h1>
<p>Pipelines are the top-level component of continuous integration, delivery, and deployment.</p>
<p>A pipeline is a set of instructions (ie. <a href="/notes/00Zg2MBUOK3gzRljklTOp">Jobs</a>) that are executed in an order that we define</p>
<p>A merge request can have many pipelines, and each pipeline must belong to one merge request.</p>
<p>Normally a pipeline is created when you push to a branch on Gitlab</p>
<p>Pipelines comprise:</p>
<ul>
<li>Jobs, which define what to do. For example, jobs that compile or test code.</li>
<li>Stages, which define when to run the jobs. For example, stages that run tests after stages that compile the code.</li>
</ul>
<p>If all jobs in a stage succeed, the pipeline moves on to the next stage.</p>
<p>If any job in a stage fails, the next stage is not executed and the pipeline ends early.</p>
<ul>
<li>we can set a job to <code>allow_failure: true</code> if we want to override this behaviour.</li>
</ul>
<p>A typical pipeline might consist of four stages, executed in the following order:</p>
<ul>
<li>A test stage, with two jobs called unittest and lint.</li>
<li>A build stage, with a job called compile.</li>
<li>A staging stage, with a job called deploy-to-stage.</li>
<li>A production stage, with a job called deploy-to-prod.</li>
</ul>
<h2 id="types-of-pipeline">Types of Pipeline<a aria-hidden="true" class="anchor-heading icon-link" href="#types-of-pipeline"></a></h2>
<p>Pipelines come in various configurations</p>
<h3 id="basic-pipelines-ie-branch-pipelines">Basic pipelines (ie. Branch Pipelines)<a aria-hidden="true" class="anchor-heading icon-link" href="#basic-pipelines-ie-branch-pipelines"></a></h3>
<p>run everything in each stage concurrently, followed by the next stage. Run the pipeline each time changes are pushed to a branch.</p>
<p>Basic pipelines have some characteristics:</p>
<ul>
<li>they run when you push a new commit to a branch.</li>
<li>they have access to some predefined variables.</li>
<li>they have access to protected variables and protected runners.</li>
</ul>
<h3 id="merge-request-pipelines">Merge Request Pipelines<a aria-hidden="true" class="anchor-heading icon-link" href="#merge-request-pipelines"></a></h3>
<p>Run only when commits associated with an MR are pushed (rather than for every commit).</p>
<ul>
<li>Merge Request jobs run in a separate pipeline from Commit jobs.</li>
</ul>
<p>Pipelines for merge requests run when you:</p>
<ul>
<li>Create a new merge request.</li>
<li>Commit changes to the source branch for the merge request.</li>
<li>Select the Run pipeline button from the Pipelines tab in the merge request.</li>
</ul>
<p>This means that if you use a squash-based workflow, jobs in the MR pipelines (ie. those associated with each commit to that MR) will have run on a different commit than the commit that actually gets merged into the <code>main</code> branch.</p>
<ul>
<li>remember that in a squash-based workflow, all the commits that went into that MR will not make its way into the repo's history. Consider that if we have a job that depends on a git commit SHA (e.g. a <code>contract-test</code> job that records the publication of the contract by the commit SHA), we cannot perform this job in the MR pipeline alone, because the contract testing framework (here, <a href="/notes/Jhamjiy0mDIq6zImBiDTj">Pact</a>) will only be aware of the commit SHA-related contracts that are associated with those commits that will never make its way into the main commit history line.</li>
</ul>
<p>Merge Request Pipelines don't run by default; they <em>must</em> be configured with <code>rules</code> or <code>only/except</code> (old method)</p>
<p>Jobs of a merge request pipeline only run on the contents of the source branch, ignoring the target branch.</p>
<p>Merge Request Pipelines also have access to additional <a href="https://docs.gitlab.com/ee/ci/variables/predefined_variables.html#predefined-variables-for-merge-request-pipelines">pre-defined variables</a> </p>
<p>Merge Request Pipelines display the <code>merge request</code> tag:</p>
<p><img src="/assets/images/2022-08-25-09-54-07.png"></p>
<h3 id="git-tag-pipelines">Git Tag Pipelines<a aria-hidden="true" class="anchor-heading icon-link" href="#git-tag-pipelines"></a></h3>
<ul>
<li>note: "git tag pipeline" is not an official type of pipeline</li>
</ul>
<p>A pipeline that runs once a git tag has been created
<img src="/assets/images/2022-11-16-04-26-39.png"></p>
<pre class="language-yml"><code class="language-yml"><span class="token key atrule">.git_tag_trigger</span><span class="token punctuation">:</span>
  <span class="token key atrule">only</span><span class="token punctuation">:</span>
    <span class="token key atrule">variables</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> $CI_COMMIT_TAG
</code></pre>
<h3 id="merged-requests-pipeline">Merged Requests Pipeline<a aria-hidden="true" class="anchor-heading icon-link" href="#merged-requests-pipeline"></a></h3>
<ul>
<li>note the merge<strong>d</strong> request<strong>s</strong></li>
</ul>
<p>merge request pipelines that act as though the changes from the source branch have already been merged into the target branch.</p>
<h3 id="merge-trains">Merge Trains<a aria-hidden="true" class="anchor-heading icon-link" href="#merge-trains"></a></h3>
<p>Merge trains use pipelines for merged results to queue merges one after the other.</p>
<h3 id="directed-acyclic-graph-pipeline-dag">Directed Acyclic Graph Pipeline (DAG)<a aria-hidden="true" class="anchor-heading icon-link" href="#directed-acyclic-graph-pipeline-dag"></a></h3>
<p>pipelines are based on relationships between jobs and can run more quickly than basic pipelines.</p>
<ul>
<li>we achieve this with the <code>needs</code> keyword, which allows us to be explicit about the job's dependencies 
<ul>
<li>ex. a post-install stage <em>needs</em> an install stage to have succeeded first</li>
</ul>
</li>
</ul>
<h3 id="multi-project-pipelines">Multi-project pipelines<a aria-hidden="true" class="anchor-heading icon-link" href="#multi-project-pipelines"></a></h3>
<p>combine pipelines for different projects together.</p>
<h3 id="parent-child-pipelines">Parent-Child pipelines<a aria-hidden="true" class="anchor-heading icon-link" href="#parent-child-pipelines"></a></h3>
<p>break down complex pipelines into one parent pipeline that can trigger multiple child sub-pipelines, which all run in the same project and with the same SHA. This pipeline architecture is commonly used for mono-repos.</p>
<hr>
<strong>Backlinks</strong>
<ul>
<li><a href="/notes/SL4aNCgB1VUFCemqEumoQ">Gitlab CI-CD</a></li>
</ul>