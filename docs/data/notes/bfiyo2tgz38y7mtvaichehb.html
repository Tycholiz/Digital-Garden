<h1 id="middleware">Middleware<a aria-hidden="true" class="anchor-heading icon-link" href="#middleware"></a></h1>
<p>Doesn't work like <a href="/notes/inMGAxYKmDgpSWcHN6tXN">express middleware</a></p>
<ul>
<li>instead, inspired by koa.js</li>
</ul>
<p>A middleware function takes 2 args:</p>
<ul>
<li>resolver data (ie. <code>root</code>, <code>args</code>, <code>context</code>, <code>info</code>)</li>
<li>the <code>next</code> function, which is used to control execution of the next middleware in the stack, as well as the resolver to which the middleware is attached.
<ul>
<li>the way this differs from Express middleware is that this <code>next</code> function returns a Promise that resolves to the value returned by the subsequent middleware and resolver in the stack.</li>
</ul>
</li>
</ul>
<p>Because of how <code>next</code> works, it is simple to perform actions before and/or after resolver execution:</p>
<pre class="language-ts"><code class="language-ts"><span class="token keyword module">export</span> <span class="token keyword">const</span> <span class="token maybe-class-name">ResolveTime</span><span class="token operator">:</span> <span class="token function-variable function"><span class="token maybe-class-name">MiddlewareFn</span></span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> info <span class="token punctuation">}</span><span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// before</span>
  <span class="token keyword">const</span> start <span class="token operator">=</span> <span class="token known-class-name class-name">Date</span><span class="token punctuation">.</span><span class="token method function property-access">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// after</span>
  <span class="token keyword">const</span> resolveTime <span class="token operator">=</span> <span class="token known-class-name class-name">Date</span><span class="token punctuation">.</span><span class="token method function property-access">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">;</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>info<span class="token punctuation">.</span><span class="token property-access">parentType</span><span class="token punctuation">.</span><span class="token property-access">name</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>info<span class="token punctuation">.</span><span class="token property-access">fieldName</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> [</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>resolveTime<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> ms]</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>If we only want to do something before an action, like log the access to the resolver, we can just place the return next() statement at the end of our middleware:</p>
<pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> <span class="token maybe-class-name">LogAccess</span><span class="token operator">:</span> <span class="token maybe-class-name">MiddlewareFn</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">TContext</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> context<span class="token punctuation">,</span> info <span class="token punctuation">}</span><span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> username<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token property-access">username</span> <span class="token operator">||</span> <span class="token string">"guest"</span><span class="token punctuation">;</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Logging access: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>username<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> -> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>info<span class="token punctuation">.</span><span class="token property-access">parentType</span><span class="token punctuation">.</span><span class="token property-access">name</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>info<span class="token punctuation">.</span><span class="token property-access">fieldName</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="guards">Guards<a aria-hidden="true" class="anchor-heading icon-link" href="#guards"></a></h3>
<p>Guarding is a technique to programmatically break the middleware stack (which is done by purposefully not calling <code>next()</code>)</p>
<ul>
<li>in doing this, the result returned from the middleware will be used instead of calling the resolver and returning its result.</li>
<li>We can also throw an error in the middleware if the execution must be terminated and an error returned to the user, e.g. when resolver arguments are incorrect.</li>
</ul>
<p>It's called a <em>guard</em> because it prevents execution of the resolver and prevents any data return.</p>