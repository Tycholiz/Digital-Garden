<!DOCTYPE html>

<html lang="en-US">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
  
  <title>Pools - Dendron</title>
  

  <link
    rel="shortcut icon"
    href="https://tycholiz.github.io/Digital-Garden/favicon.ico"
    type="image/x-icon"
  />
  <link
    rel="stylesheet"
    href="https://tycholiz.github.io/Digital-Garden/assets/css/just-the-docs-default.css"
  />
  <script
    type="text/javascript"
    src="https://tycholiz.github.io/Digital-Garden/assets/js/just-the-docs.js"
  ></script>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.22.0/themes/prism.min.css"
  />
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"
    integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X"
    crossorigin="anonymous"
  />
  <script
    type="text/javascript"
    src="https://tycholiz.github.io/Digital-Garden/assets/js/vendor/lunr.min.js"
  ></script>
  
  <meta name="viewport" content="width=device-width, initial-scale=1" />
   
  
<meta name="description" content="Publishable code notes">
<meta name="author" content="">

<link rel="canonical" href="https://tycholiz.github.io/notes/740ec8d9-29c6-4ce6-b992-5b68ff4a3e1d.html">

<meta property="og:type" content="article">
<meta property="og:url" content="https://tycholiz.github.io/notes/740ec8d9-29c6-4ce6-b992-5b68ff4a3e1d.html">
<meta property="og:description" content="Publishable code notes">
<meta property="og:image" content="https://tycholiz.github.ioundefined">

<meta name="twitter:card" content="summary">

<meta name="twitter:url" content="https://tycholiz.github.io/notes/740ec8d9-29c6-4ce6-b992-5b68ff4a3e1d.html">
<meta name="twitter:description" content="Publishable code notes">
<meta name="twitter:image" content="https://tycholiz.github.ioundefined">


  <meta property="og:title" content="Pools - Dendron" />
  <meta name="twitter:title" content="Pools - Dendron" />
  
</head>


<body>
    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
      <symbol id="svg-link" viewBox="0 0 24 24">
        <title>Link</title>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link">
          <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
        </svg>
      </symbol>
      <symbol id="svg-search" viewBox="0 0 24 24">
        <title>Search</title>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search">
          <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
      </symbol>
      <symbol id="svg-menu" viewBox="0 0 24 24">
        <title>Menu</title>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu">
          <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </symbol>
      <symbol id="svg-arrow-right" viewBox="0 0 24 24">
        <title>Expand</title>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right">
          <polyline points="9 18 15 12 9 6"></polyline>
        </svg>
      </symbol>
      <symbol id="svg-doc" viewBox="0 0 24 24">
        <title>Document</title>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file">
          <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline>
        </svg>
      </symbol>
    </svg>

    <div class="side-bar">
      <div class="site-header">
        <a href="https://tycholiz.github.io/Digital-Garden" class="site-title lh-tight">
  Dendron

 </a>
        <a href="#" id="menu-button" class="site-button">
          <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg>
        </a>
      </div>

      <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav">
      </nav>
      <footer class="site-footer">
        ðŸŒ± with ðŸ’• using <a href="https://www.dendron.so/"> Dendron ðŸŒ² </a>
      </footer>
    </div>
    <div class="main" id="top">
        <div id="main-header" class="main-header">
          
            <div class="search">
              <div class="search-input-wrap">
                <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Dendron" aria-label="Search Dendron" autocomplete="off">
                <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label>
              </div>
              <div id="search-results" class="search-results"></div>
            </div>
          
          
    </div>
    <div id="main-content-wrap" class="main-content-wrap">
      
        
          <nav aria-label="Breadcrumb" class="breadcrumb-nav">
            <ol class="breadcrumb-nav-list"><li class="breadcrumb-nav-list-item"><a href="https://tycholiz.github.io/Digital-Garden">Root</a></li><li class="breadcrumb-nav-list-item"><a href="https://tycholiz.github.io/Digital-Garden/notes/dff06309-f792-4ee2-a0ef-529972167027.html">Postgres</a></li><li class="breadcrumb-nav-list-item"><a href="https://tycholiz.github.io/Digital-Garden/notes/8409f37c-4ea3-4bba-acd0-d12ac64a141c.html">Connection</a></li><li class="breadcrumb-nav-list-item">Pools</li></ol>
          </nav>
        
      
      <div id="main-content" class="main-content" role="main">

        
        

        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
        <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>

        

        <script>
          $(function () {
            $('[data-toggle="popover"]').popover({html: true})
          })
        </script>

        

<div id="main" role="main">

  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Pools">
    
    <meta itemprop="datePublished" content="2021-03-04T16:37:26+00:00">
    <meta itemprop="dateModified" content="2021-03-09T17:35:17+00:00">

    <div class="page__inner-wrap">

      

      <section class="page__content" itemprop="text">

        

        <h1 id="pools"><a aria-hidden="true" class="anchor-heading" href="#pools"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Pools</h1>
<h3 id="why"><a aria-hidden="true" class="anchor-heading" href="#why"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Why?</h3>
<ul>
<li>
<p>Connecting a new client to the PostgreSQL server requires a handshake which can take 20-30 milliseconds. During this time passwords are negotiated, SSL may be established, and configuration information is shared with the client &#x26; server. Incurring this cost every time we want to execute a query would substantially slow down our application.</p>
</li>
<li>
<p>The PostgreSQL server can only handle a limited number of clients at a time. Depending on the available memory of your PostgreSQL server you may even crash the server if you connect an unbounded number of clients. </p>
</li>
<li>
<p>PostgreSQL can only process one query at a time on a single connected client in a first-in first-out manner. If your multi-tenant web application is using only a single connected client all queries among all simultaneous requests will be pipelined and executed serially, one after the other. No good!</p>
</li>
</ul>
<p>The client pool allows you to have a reusable pool of clients you can check out, use, and return. You generally want a limited number of these in your application and usually just 1. Creating an unbounded number of pools defeats the purpose of pooling at all.</p>
<h3 id="implementing"><a aria-hidden="true" class="anchor-heading" href="#implementing"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Implementing</h3>
<p>You must always return the client to the pool if you successfully check it out, regardless of whether or not there was an error with the queries you ran on the client. If you don't check in the client your application will leak them and eventually your pool will be empty forever and all future requests to check out a client from the pool will wait forever.</p>
<h3 id="connection-pooling"><a aria-hidden="true" class="anchor-heading" href="#connection-pooling"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Connection Pooling</h3>
<ul>
<li>a pool sits between the postgres frontend (ex. postgraphile, postgres-node) and the postgres server. The pooler speaks the postgres language, so understands all incoming queries.
<ul>
<li>Therefore, the server sees the requests as coming from the pg pool, and the postgres frontend sees the pool as handling the requests. 
<ul>
<li>Therefore,
<ul>
<li>without a pool, if we had 20 db connections and 8 were idle, all 20 would be eating up postgres resources (memory)</li>
<li>with a pool, those 8 idle connections remain in the pool and don't connect to the database, freeing up resources for us. From the database perspective, there are only 12 connections.</li>
</ul>
</li>
</ul>
</li>
<li>the frontend/backend paradigm here is no different from in web developent. In postgres, we have users who interact with the database. The client generates a query, and that query gets sent off to the postgres backend, where it interprets the request, performs the actions, then returns the data to the frontend. </li>
</ul>
</li>
<li>when a client is connected to the pool, we say it is a "virtual connection", and if the pooled client is connected to the database, it is a "physical connection" </li>
<li>2 main options: <code>pgpool-II</code> and <code>pgBouncer</code>
<ul>
<li>pgBouncer does one job and does it well. pgpool-II is more of a swiss army knife, with load balancing included
<ul>
<li><code>pgpool-II</code> seems to be more out-dated</li>
</ul>
</li>
<li><a href="https://scalegrid.io/blog/postgresql-connection-pooling-part-4-pgbouncer-vs-pgpool/">comparison</a></li>
</ul>
</li>
</ul>
<h4 id="pgbouncer"><a aria-hidden="true" class="anchor-heading" href="#pgbouncer"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>pgBouncer</h4>
<ul>
<li>When PgBouncer receives a client connection, it first performs authentication on behalf of the PostgreSQL server.
<ul>
<li>when a password is provided, one of 2 things happens:
<ol>
<li>PgBouncer first checks the userslist.txt file â€“ this file specifies a set of (username, md5 encrypted passwords) tuples. If the username exists in this file, the password is matched against the given value. No connection to PostgreSQL server is made. </li>
<li>If passthrough authentication is setup, and the user is not found in the userslist.txt file, PgBouncer searches for an auth_query. It connects to PostgreSQL as a predefined user (whose password must be present in the userslist.txt file) and executes the auth-query to find the userâ€™s password and matches it to the provided value.</li>
</ol>
</li>
</ul>
</li>
<li>When the client executes an SQL statement:
<pre><code>1. PgBouncer checks for a cached connection
2. if found, it returns the connection to the client. Otherwise, it creates a new connection
</code></pre>
<img src="/Digital-Garden/:/bde888d39a1c41fa99e619df6db6f56b" alt="a891779b4493983dd662f11960423a72.png"></li>
</ul><span id="navId" data="740ec8d9-29c6-4ce6-b992-5b68ff4a3e1d"></span>

                
      </section>

      
    </div>

    
  </article>

  
  
</div>


        
          <hr>
          <footer>
            
            

            
                
              </div>
          </footer>
        
    </div>
</div>


  

  <div class="search-overlay"></div>

</div>
</body>
</html>
